
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"> 
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:v="urn:schemas-microsoft-com:vml"> 
<head> 
<meta http-equiv="content-type" content="text/html; charset=UTF-8" /> 
<meta name="viewport" content="width=device-width; initial-scale=1.0; minimum-scale=1.0; maximum-scale=1.0; user-scalable=0;" /> 
<meta http-equiv="content-script-type" content="text/javascript" /> 
<meta http-equiv="content-style-type" content="text/css" /> 
<meta http-equiv="cache-control" content="max-age=0" /> 
<meta http-equiv="cache-control" content="no-cache" /> 
<title>V3 TEST CASE</title> 
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.8.3/jquery.min.js"></script> 
<script src="../hex_v3.02_core.js" type="text/javascript" content="text/html; charset=utf-8"></script> 
<script src="../getXYListByRect.js" type="text/javascript" content="text/html; charset=utf-8"></script>
<script src="../getXYListByRect_v3.026.js" type="text/javascript" content="text/html; charset=utf-8"></script>
<script type="text/javascript">
    var mode=0;
    var option=location.search;
    option=(option.substring(1)).split("=");
    if(option[1]) mode = parseInt(option[1]); // 0:code -> HEX, 1:coordinate -> HEX, 2:code -> XY, 3:XY -> HEX, 4: coordinate ->XY
    GEOHEX.cache_on = false;

    var testMode = [
        {
            'casename' : 'code2HEX',
            'mode'     : 'code -> HEX',
//            'cache' : GEOHEX.cache_on,
            'output'   : 'zone.lat, zone.lon (expectaion)',
            'logic'    : function(test_case) {
                var lat  = parseFloat(test_case[1]);
                var lon  = parseFloat(test_case[2]);
                var code = test_case[0];
                var zone = GEOHEX.getZoneByCode(code);

                return {
                    'err'     : (Math.abs(zone.lat - lat) < 0.0000000001 && Math.abs(zone.lon - lon) < 0.0000000001) ? 0 : 1,
                    'message' : code + " ____ " + (zone.lat) + ", " + (zone.lon) + " (" + lat + ", " + lon + ")"
                };
            }
        },
        {
            'casename' : 'coord2HEX',
            'mode'     : 'coordinate -> HEX',
//            'cache' : GEOHEX.cache_on,
            'input'    : 'level, lat, lon',
            'output'   : 'zone.code (expectaion)',
            'logic'    : function(test_case) {
                var level = parseInt(test_case[0]);
                var lat   = parseFloat(test_case[1]);
                var lon   = parseFloat(test_case[2]);
                var code  = test_case[3];
                var zone  = GEOHEX.getZoneByLocation(lat, lon, level);

                return {
                    'err'     : zone.code == code ? 0 : 1,
                    'message' : level + ", " + lat + ", " + lon + " ____ " + zone.code + " (" + code + ")"
                };
            }
        },
        {
            'casename' : 'coord2XY',
            'mode'     : 'coordinate -> XY',
//            'cache' : GEOHEX.cache_on,
            'input'    : 'level, lat, lon',
            'output'   : 'X, Y (expectaion)',
            'logic'    : function(test_case) {
                var level = parseInt(test_case[0]);
                var lat   = parseFloat(test_case[1]);
                var lon   = parseFloat(test_case[2]);
                var X     = parseInt(test_case[3]);
                var Y     = parseInt(test_case[4]);
                var XY  = GEOHEX.getXYByLocation(lat, lon, level);

                return {
                    'err'     : (XY.x == X)&&(XY.y == Y) ? 0 : 1,
                    'message' : level + ", " + lat + ", " + lon + " ____ " + XY.x + ", " + XY.y + " (" + X + ", " + Y + ")"
                };
            }
        },
        {
            'casename' : 'code2XY',
            'mode'     : 'code -> XY',
//            'cache' : GEOHEX.cache_on,
            'input'    : 'code',
            'output'   : 'zone.x, zone.y (expectaion)',
            'logic'    : function(test_case) {
                var code  = test_case[0];
                var X     = parseInt(test_case[1]);
                var Y     = parseInt(test_case[2]);
                var zone  = GEOHEX.getZoneByCode(code);
                var h_max = Math.pow(3,code.length);

                return {
                    'err'     : (zone.x == X)&&(zone.y == Y) ? 0 : 1,
                    'message' : code + " ____ " + zone.x + ", " + zone.y + " (" + X + ", " + Y + ")"
                };
            }
        },
        {
            'casename' : 'XY2HEX',
            'mode'     : 'XY -> HEX',
//            'cache' : GEOHEX.cache_on,
            'input'    : 'level, X, Y',
            'output'   : 'zone.code (expectaion)',
            'logic'    : function(test_case) {
                var level = parseInt(test_case[0]);
                var X     = parseInt(test_case[1]);
                var Y     = parseInt(test_case[2]);
                var code  = test_case[3];
                var zone  = GEOHEX.getZoneByXY(X, Y, level);

                return {
                    'err'     : zone.code == code ? 0 : 1,
                    'message' : level + ", " + X + ", " + Y + " ____ " + zone.code + " (" + code + ")"
                };
            }
        },
        {
            'casename' : 'Rect2XYs',
            'mode'     : 'Rect -> XYs',
//            'cache' : GEOHEX.cache_on,
            'input'    : 'South, West, North, East, Level, Buffer',
            'output'   : 'List of XYs (expectaion)',
            'logic'    : function(test_case) {
                var south  = parseFloat(test_case[0]);
                var west   = parseFloat(test_case[1]);
                var north  = parseFloat(test_case[2]);
                var east   = parseFloat(test_case[3]);
                var level  = parseInt(test_case[4]);
                var buffer = test_case[5];
                var expect = test_case[6];
                var result = getXYListByRect(south, west, north, east, level , buffer);

                var errMsg = '';
                var r_len  = result.length;
                var e_len  = expect.length;

                $.each(expect,function(e_idx,e_dat) {
                    var e_exist = false;
                    $.each(result,function(r_idx,r_dat) {
                        if (e_dat.x == r_dat.x && e_dat.y == r_dat.y) {
                            e_exist = true;
                            result.splice(r_idx,1);
                            return false;
                        }
                    });
                    if (!e_exist) {
                        errMsg += '<br>X:' + e_dat.x + ' and Y:' + e_dat.y + ' is included in expected but not in result.';
                    }
                });

                $.each(result,function(r_idx,r_dat) {
                    errMsg += '<br>X:' + r_dat.x + ' and Y:' + r_dat.y + ' is included in result but not in expected.';
                });

                return {
                    'err'     : errMsg === '' ? 0 : 1,
                    'message' : 'SW: ' + south + ',' + west + " NE: " + north + ',' + east + " Level: " + level + " Buffer: " + buffer + " Zones: " + r_len + " (" + e_len + ') <a href="./visualCheckTool/v3.02_rect.html?rect=' + south + ',' + west + ',' + north + ',' + east + ',' + level +'">Visual checker</a>' + errMsg
                };
            }
        },
        {
            'casename' : 'CACHE',
            'mode'     : 'CACHE Test',
//            'cache' : GEOHEX.cache_on,
            'input'    : 'cache_on',
            'output'   : 'cache_check (expectaion)',
            'logic'    : function(test_case) {
                var level  = parseInt(test_case[0]);
                var X      = parseInt(test_case[1]);
                var Y      = parseInt(test_case[2]);
                var mode   = test_case[3];

                GEOHEX.cache_on = mode;

                var b_zone = GEOHEX.getZoneByXY(X, Y, level);
                b_zone.cache_check = true;
                var a_zone = GEOHEX.getZoneByXY(X, Y, level);
                var check  = a_zone.cache_check || false;

                GEOHEX.cache_on = false;

                return {
                    'err'     : a_zone.code == b_zone.code && mode == check ? 0 : 1,
                    'message' : level + ", " + X + ", " + Y + " ____ " + a_zone.code + ": Cache: " + check + " (" + mode + ")"
                };
            }
        },
        {
            'casename' : 'Rect2XYsBenchmark',
            'mode'     : 'Rect2XYsBenchmark',
//            'cache' : GEOHEX.cache_on,
            'input'    : 'South, West, North, East, Level, Buffer',
            'output'   : 'List of XYs (expectaion)',
            'logic'    : function(test_case) {
                var south  = parseFloat(test_case[0]);
                var west   = parseFloat(test_case[1]);
                var north  = parseFloat(test_case[2]);
                var east   = parseFloat(test_case[3]);
                var level  = parseInt(test_case[4]);
                var buffer = test_case[5];
                var result1; //= test_case[6];
                var result2; //= getXYListByRect(south, west, north, east, level , buffer);

                var errMsg = '';

                var d      = new Date();
                var sec1   = parseInt(d.getTime());
                var mil1   = parseFloat("0." + d.getMilliseconds());

                for (var i=0; i<10000; i++) {
                    result1 = getXYListByRect(south, west, north, east, level , buffer);
                }

                d = new Date();
                var sec2   = parseInt(d.getTime());
                var mil2   = parseFloat("0." + d.getMilliseconds());

                for (var i=0; i<10000; i++) {
                    result2 = getXYListByRect2(south, west, north, east, level , buffer);
                }

                d = new Date();
                var sec3   = parseInt(d.getTime());
                var mil3   = parseFloat("0." + d.getMilliseconds());

                var delsec1 = sec2 - sec1;
                var delsec2 = sec3 - sec2;
                var delta1  = parseFloat(delsec1) + mil2 - mil1;
                var delta2  = parseFloat(delsec2) + mil3 - mil2;

                var r1_len  = result1.length;
                var r2_len  = result2.length;

                $.each(result1,function(r1_idx,r1_dat) {
                    var r1_exist = false;
                    $.each(result2,function(r2_idx,r2_dat) {
                        if (r1_dat.x == r2_dat.x && r1_dat.y == r2_dat.y) {
                            r1_exist = true;
                            result2.splice(r2_idx,1);
                            return false;
                        }
                    });
                    if (!r1_exist) {
                        errMsg += '<br>X:' + r1_dat.x + ' and Y:' + r1_dat.y + ' is included in Logic 1 but not in Logic 2.';
                    }
                });

                $.each(result2,function(r2_idx,r2_dat) {
                    errMsg += '<br>X:' + r2_dat.x + ' and Y:' + r2_dat.y + ' is included in Logic 2 but not in Logic 1.';
                });

                return {
                    'err'     : errMsg === '' ? 0 : 1,
                    'message' : 'SW: ' + south + ',' + west + " NE: " + north + ',' + east + " Level: " + level + " Buffer: " + buffer + " Zones: ( Logic 1 : " + r1_len + " Logic 2 : " + r2_len + ' ) <br>Faster Logic: ' + (delta1 > delta2 ? "Logic 2" : "Logic 1") + ' ( Logic 1 : ' + delta1 + ' sec, Logic 2 : ' + delta2 + ' sec ) ' + errMsg
                };
            }
        }
    ];

    function runTest(index) {
        $('#log').empty();
        var testMeta  = testMode[index];
        $('#mode').html(testMeta['mode']);
//        $('#cache').html(testMeta['cache']);
        var testJson  = 'hex_v3.02_test_' + testMeta['casename'] + '.json';
        $('#file').html("<a href='./" + testJson + "'>" + testJson + "</a>");
        $('#input').html(testMeta['input']);
        $('#output').html(testMeta['output']);

        var testLogic = testMeta['logic'];
        $.getJSON(
            './' + testJson,
            {},
            function (testData) {
                if (testData) {
                    var err = 0;
                    $('#count').text(testData.length);
                    $.each(testData,function(i,line) {
                        var result = testLogic(line);
                        addLog((result.err ? "[<span class='NG'>NG</span>] " : "[<span class='OK'>OK</span>] " ) + result.message);
                        err += result.err;
                    });
                    if(err) alert(err +"件のエラー");
                } else {
                    $('#count').text('0');
                    addLog("NO TEST CASE");
                }
            }
        );
    }
    
    function initialize() {
        $('#version').text(GEOHEX.version);
        $('#cache').text(GEOHEX.cache_on);
        $.each(testMode,function(i,mode) {
            $('#link').append(' <a href="?mode=' + i + '">' + i + ': ' + mode['mode'] + '</a>');
        });
        runTest(mode);
    }
    function addLog(_text){
        $('#log').append("<br>"+_text);
    }
</script> 
<style type="text/css"> 
    html,body{
    }
    .NG{color: #FF0000}
    .OK{color: #0000FF}
@-webkit-keyframes mycolor {
 
    0%  {
                right:100%;
        }
    100%    {
                right:0;
        }
 
    }
#level_r{
  float:right;
  margin:5px;
  font-size:11px;
}
 
</style> 
 
</head> 
<body onload="initialize()">
<div style="width:100%;border-bottom:1px dotted #000000;color:#999999;margin-bottom:10px;">OPTION(URL?mode=) <span id="link"></span></div>
<div>TEST_CASE: <span id="file"></span></div>
<div>VERSION: <span id="version"></span></div>
<div>MODE: <span id="mode"></span></div>
<div>CACHE: <span id="cache"></span></div>
<div>TOTAL_COUNT: <span id="count"></span></div>
    ---------------------------------------------------------------------------------------<br />INPUT: <span id="input"></span> ____ OUTPUT: <span id="output"></span><br />---------------------------------------------------------------------------------------<div id ="log"></div>
</body> 
 
</html> 